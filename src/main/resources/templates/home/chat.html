<!DOCTYPE html>
<html th:replace="~{layout/homeLayoutForm::layout (~{::header},~{::section})}">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>채팅</title>
</head>
<body>

<header>
    <a href="/"><span>SEOMOIM</span></a>
    <a href="/member/logout"><p>로그아웃</p>
    <img src="/img/logout.png" alt="logout.png"/></a>
</header>

<section>
    <div th:each="chatRoom:${chatRooms}" class="alarm-item">
        <a th:href="@{/chat/chat-form/{roomId}(roomId=${chatRoom.id})}">
            <div th:if="${memberId == chatRoom.ownerMember.id}">
                <div class="chat-container">
                    <img th:if="${chatRoom?.requestMember?.profileImage?.profileImageUrl}"
                         th:src="${chatRoom?.requestMember?.profileImage?.profileImageUrl}">
                    <img th:unless="${chatRoom?.requestMember?.profileImage?.profileImageUrl}" src="/img/profile2.png">
                    <div class="chat-item">
                        <span th:text="${chatRoom.requestMember.name}">서은정</span>
                        <p th:text="${chatRoom.getMessages().size() > 0 ? chatRoom.getMessages().get(chatRoom.getMessages().size() - 1).content : 'No messages'}">내용</p>
                    </div>
                    <div class="chat-info">
                        <p th:text="${chatRoom.getMessages().size() > 0 ? #temporals.format(chatRoom.getMessages().get(chatRoom.getMessages().size() - 1).createdAt, 'a hh:mm') : ''}">전송시간</p>
                        <p>1개</p>
                    </div>
                </div>
            </div>

            <div th:if="${memberId == chatRoom.requestMember.id}">
                <div class="chat-container">
                    <img th:if="${chatRoom?.ownerMember?.profileImage?.profileImageUrl}"
                         th:src="${chatRoom.ownerMember?.profileImage?.profileImageUrl}">
                    <img th:unless="${chatRoom?.ownerMember?.profileImage?.profileImageUrl}" src="/img/profile2.png">
                    <div class="chat-item">
                        <span th:text="${chatRoom.ownerMember.name}">서은정</span>
                        <p th:text="${chatRoom.getMessages().size() > 0 ? chatRoom.getMessages().get(chatRoom.getMessages().size() - 1).content : 'No messages'}">내용</p>
                    </div>
                    <div class="chat-info">
                        <p th:text="${chatRoom.getMessages().size() > 0 ? #temporals.format(chatRoom.getMessages().get(chatRoom.getMessages().size() - 1).createdAt, 'a hh:mm') : ''}">전송시간</p>
                        <p>1개</p>
                    </div>
                </div>
            </div>
        </a>
        <button class="post-but" id="postButton">+</button>
    </div>




    <script th:inline="javascript">
    //     var stompClient = null;
    //     var memberId = /*[[${memberId}]]*/ null;
    //     var chatRoomIds = /*[[${#strings.arrayJoin(chatRoomIds, ',') }]]*/ null;
    //
    //     function connect() {
    //         var socket = new SockJS('/chat');
    //
    //         stompClient = Stomp.over(socket);
    //
    //         stompClient.connect({}, function (frame) {
    //             console.log('Connected: ' + frame);
    //
    //             var roomIdArray = chatRoomIds.split(',');
    //
    //             roomIdArray.forEach(function (roomId) {
    //                 stompClient.subscribe('/sub/chatMessage/' + roomId, function (response) {
    //                     var messageContent = JSON.parse(response.body);
    //                     handleReceivedMessage(messageContent);
    //                 });
    //             });
    //         });
    //     }
    //
    //     var senderName;
    //     var roomId;
    //     var content
    //     var createdAt;
    //     var senderId;
    //
    //     function handleReceivedMessage(message) {
    //         console.log('받은 메시지:', message);
    //         content = message.content;
    //         senderId = message.senderId;
    //         senderName = message.senderName;
    //         createdAt = new Date(message.createdAt).toLocaleString('ko-KR', {
    //             hour: '2-digit',
    //             minute: '2-digit',
    //             hour12: true
    //         });
    //         roomId = message.roomId;
    //
    //         var newChatItem = `
    // <a href="/chat/chat-form/${roomId}/${senderId}">
    //   <div class="chat-container">
    //     <img src="/img/profile2.png">
    //     <div class="chat-item">
    //       <span>${senderName}</span>
    //       <p>${content}</p>
    //     </div>
    //     <div class="chat-info">
    //       <p>${createdAt}</p>
    //       <p>1개</p>
    //     </div>
    //   </div>
    // </a>`;
    //
    //         console.log('newChatItem:', newChatItem);
    //
    //         // Append the new chat item to the '.alarm-item'
    //         $('.alarm-item').append(newChatItem);
    //
    //     }
    //
    //
    //     document.addEventListener('DOMContentLoaded', function () {
    //         connect();
    //     });


        const postButton = document.getElementById('postButton');
        postButton.addEventListener('click', function () {
            window.location.href = '/moims/post'
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</section>

</body>
</html>
